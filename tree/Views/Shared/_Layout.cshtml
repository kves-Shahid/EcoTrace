@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoTrace</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-light bg-white border-bottom mb-3 shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold text-success" asp-controller="Home" asp-action="Index">EcoTrace</a>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    <ul class="navbar-nav flex-grow-1">
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-controller="Home" asp-action="Index">Home</a>
                        </li>

                        @if (SignInManager.IsSignedIn(User))
                        {
                            <li class="nav-item">
                                <a class="nav-link text-dark fw-bold" asp-controller="Home" asp-action="MyMissions">
                                    <i class="bi bi-person-badge"></i> My Missions
                                </a>
                            </li>
                        }
                    </ul>
                    <ul class="navbar-nav">
                        @if (SignInManager.IsSignedIn(User))
                        {
                            @if (User.IsInRole("Admin"))
                            {
                                <li class="nav-item">
                                    <a class="nav-link text-danger fw-bold" asp-controller="Admin" asp-action="Dashboard">Admin Panel</a>
                                </li>
                            }

                            <li class="nav-item"><span class="nav-link text-dark">Welcome, @User.Identity?.Name!</span></li>
                            <li class="nav-item">
                                <form asp-controller="Account" asp-action="Logout" method="post" class="d-inline">
                                    <button type="submit" class="nav-link btn btn-link text-dark border-0">Logout</button>
                                </form>
                            </li>
                        }
                        else
                        {
                            <li class="nav-item"><a class="nav-link text-dark" asp-controller="Account" asp-action="Register">Sign Up</a></li>
                            <li class="nav-item"><a class="nav-link text-dark" asp-controller="Account" asp-action="Login">Login</a></li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        @RenderBody()
    </div>

    @if (SignInManager.IsSignedIn(User))
    {
        <button class="btn btn-success rounded-circle shadow-lg position-fixed bottom-0 end-0 m-4 p-3"
                style="z-index: 1000;"
                onclick="toggleAiChat()">
            <i class="bi bi-robot fs-3"></i>
        </button>

        <div id="aiChatBox" class="card shadow-lg position-fixed bottom-0 end-0 m-4 d-none"
             style="width: 350px; z-index: 1001; border-radius: 15px; overflow: hidden; margin-bottom: 80px !important;">
            <div class="card-header bg-success text-white fw-bold d-flex justify-content-between">
                <span><i class="bi bi-stars"></i> EcoTrace AI</span>
                <button type="button" class="btn-close btn-close-white" onclick="toggleAiChat()"></button>
            </div>

            <div id="aiChatHistory" class="card-body bg-light" style="height: 300px; overflow-y: auto;">
                <div class="text-muted small mb-3 text-center" id="aiLoading">Loading chat history...</div>
            </div>

            <div class="card-footer bg-white">
                <div class="input-group">
                    <input type="text" id="aiInput" class="form-control form-control-sm" placeholder="Ask AI..." onkeypress="if(event.key === 'Enter') sendAiMessage()" />
                    <button class="btn btn-success btn-sm" onclick="sendAiMessage()"><i class="bi bi-send"></i></button>
                </div>
            </div>
        </div>

        <script>
            let isChatLoaded = false;

            async function toggleAiChat() {
                const chatBox = document.getElementById('aiChatBox');
                chatBox.classList.toggle('d-none');

                // Load history from database only on first open
                if (!chatBox.classList.contains('d-none') && !isChatLoaded) {
                    const chatHistory = document.getElementById('aiChatHistory');
                    try {
                        const response = await fetch('/api/aichat/history');
                        const data = await response.json();

                        document.getElementById('aiLoading').classList.add('d-none');

                        data.forEach(msg => {
                            if (msg.isAi) {
                                chatHistory.innerHTML += `<div class="text-start mb-2"><span class="bg-white border p-2 rounded-3 d-inline-block small" style="max-width: 85%;">${msg.text}</span></div>`;
                            } else {
                                chatHistory.innerHTML += `<div class="text-end mb-2"><span class="bg-success text-white p-2 rounded-3 d-inline-block small" style="max-width: 85%;">${msg.text}</span></div>`;
                            }
                        });
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                        isChatLoaded = true;
                    } catch (e) {
                        document.getElementById('aiLoading').innerText = "Start a new conversation!";
                    }
                }
            }

            async function sendAiMessage() {
                const input = document.getElementById('aiInput');
                const message = input.value.trim();
                if (!message) return;

                const chatHistory = document.getElementById('aiChatHistory');

                // Render user message immediately
                chatHistory.innerHTML += `<div class="text-end mb-2"><span class="bg-success text-white p-2 rounded-3 d-inline-block small" style="max-width: 85%;">${message}</span></div>`;
                input.value = '';
                chatHistory.scrollTop = chatHistory.scrollHeight;

                // Fetch AI Response
                try {
                    const response = await fetch('/api/aichat/ask', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: message })
                    });
                    const data = await response.json();

                    chatHistory.innerHTML += `<div class="text-start mb-2"><span class="bg-white border p-2 rounded-3 d-inline-block small" style="max-width: 85%;">${data.reply}</span></div>`;
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                } catch (error) {
                    chatHistory.innerHTML += `<div class="text-start mb-2 text-danger small">Error connecting to AI.</div>`;
                }
            }
        </script>
    }
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>