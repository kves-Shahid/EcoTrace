@model IEnumerable<EcoTraceApp.Models.ChatMessage>
@{
    ViewData["Title"] = "Event Chat";
    var currentUserId = ViewBag.CurrentUserId as string;
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm" style="border-radius: 20px; overflow: hidden;">

                <div class="card-header bg-success text-white p-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-chat-dots me-2"></i> @ViewBag.EventTitle - Community Chat</h5>
                    <a asp-action="Details" asp-route-id="@ViewBag.EventId" class="btn btn-sm btn-light fw-bold text-success rounded-pill">Back to Event</a>
                </div>

                <div class="card-body bg-light" style="height: 500px; overflow-y: auto; display: flex; flex-direction: column;" id="chatBox">
                    @if (!Model.Any())
                    {
                        <div class="text-center text-muted mt-auto mb-auto">
                            <i class="bi bi-chat-square-text display-4 opacity-50"></i>
                            <p class="mt-2">No messages yet. Say hello to the volunteers!</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var msg in Model)
                        {
                            bool isMe = msg.UserId == currentUserId;
                            <div class="d-flex mb-3 @(isMe ? "justify-content-end" : "justify-content-start")">
                                <div style="max-width: 75%;">
                                    @if (!isMe)
                                    {
                                        <div class="small text-muted ms-1 mb-1">@msg.User?.Email</div>
                                    }
                                    <div class="p-3 shadow-sm @(isMe ? "bg-success text-white" : "bg-white text-dark")"
                                         style="border-radius: 20px; @(isMe ? "border-bottom-right-radius: 5px;" : "border-bottom-left-radius: 5px;")">
                                        @msg.MessageText
                                    </div>
                                    <div class="small text-muted mt-1 @(isMe ? "text-end me-1" : "ms-1")">
                                        @msg.Timestamp.ToString("MMM dd, h:mm tt")
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>

                <div class="card-footer bg-white p-3 border-0">
                    <form asp-action="SendMessage" method="post" class="d-flex gap-2">
                        <input type="hidden" name="eventId" value="@ViewBag.EventId" />
                        <input type="text" name="messageText" class="form-control rounded-pill px-4" placeholder="Type your message here..." required autocomplete="off" />
                        <button type="submit" class="btn btn-success rounded-pill px-4 fw-bold">Send <i class="bi bi-send ms-1"></i></button>
                    </form>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    window.onload = function() {
        var chatBox = document.getElementById("chatBox");
        chatBox.scrollTop = chatBox.scrollHeight;
    };
</script>